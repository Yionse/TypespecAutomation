trigger:
  - master
  - test/pipeline

jobs:
  - job: RunElectronUITestsOnLinux
    pool:
      vmImage: "ubuntu-latest"

    steps:
      - script: |
          echo "ğŸ”§ å®‰è£… Electron æ‰€éœ€ä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-0 libxss1 libasound2 libnss3 libx11-xcb1 \
            libxcomposite1 libxrandr2 libxcb-dri3-0 libdrm2 libgbm1 \
            libxdamage1 libatk-bridge2.0-0 libcups2 libxkbcommon0 \
            xvfb
        displayName: "Install Electron runtime dependencies"

      - task: NodeTool@0
        inputs:
          versionSpec: "20.18.3"
        displayName: "Install Node.js"

      - script: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci
          npx playwright install
        displayName: "Install dependencies and Playwright"

      - script: |
          echo "ğŸš€ å¯åŠ¨è™šæ‹Ÿ X11 (xvfb) å¹¶è¿è¡Œ Electron æµ‹è¯•..."
          Xvfb :99 -ac &
          export DISPLAY=:99

          echo "ğŸ” æ‰“å° Electron å¯åŠ¨è·¯å¾„"
          node -e "console.log('Executable path:', require('./path-to-your-inject-module').inject('executablePath'))"

          npm run test || {
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œå°è¯•è¾“å‡ºæ—¥å¿—ï¼š"
            cat ./tests-logs-*.txt || true
          }
        displayName: "Run Playwright Electron UI Tests"
        env:
          CI: true
          BUILD_ARTIFACT_STAGING_DIRECTORY: $(Build.ArtifactStagingDirectory)
          ELECTRON_DISABLE_SANDBOX: "1"
        continueOnError: true

      - task: PublishBuildArtifacts@1
        inputs:
          path: "$(Build.ArtifactStagingDirectory)"
          artifact: "screenshots"
          publishLocation: "Container"
          includePatterns: "images/**/*.png"
        displayName: "ğŸ“¤ ä¸Šä¼ æˆªå›¾"
